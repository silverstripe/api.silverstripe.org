### SILVERSTRIPE START ###

# Deny access to templates (but allow from localhost)
<Files *.ss>
    Require ip 127.0.0.1
</Files>

# Deny access to IIS configuration
<Files web.config>
    Require all denied
</Files>

# Deny access to YAML configuration files which might include sensitive information
<Files ~ "\.ya?ml$">
    Require all denied
</Files>

# Route errors to static pages automatically generated by SilverStripe
# (these don't appear to work correctly)
# ErrorDocument 404 /assets/error-404.html
# ErrorDocument 500 /assets/error-500.html

<IfModule mod_rewrite.c>

    # Turn off index.php handling requests to the homepage fixes issue in apache >=2.4
    <IfModule mod_dir.c>
        DirectoryIndex disabled
        DirectorySlash On
    </IfModule>

    SetEnv HTTP_MOD_REWRITE On
    RewriteEngine On

    # Enable HTTP Basic authentication workaround for PHP running in CGI mode
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Deny access to potentially sensitive files and folders
    RewriteRule ^vendor(/|$) - [F,L,NC]
    RewriteRule ^\.env - [F,L,NC]
    RewriteRule silverstripe-cache(/|$) - [F,L,NC]
    RewriteRule composer\.(json|lock) - [F,L,NC]
    RewriteRule (error|silverstripe|debug)\.log - [F,L,NC]

    ### =============== Legacy redirects ===============

    # Packages no longer exist
    RewriteCond %{REQUEST_URI} ^(.*)en/.*/package-.*\.html [NC]
    RewriteRule ^(.*)$ %1 [L,R=302]

    # 2.x no longer exists
    RewriteCond %{REQUEST_URI} ^(.*)en/2[.] [NC]
    RewriteRule ^(.*)$ %1 [L,R=302]

    # Redirect non-languaged minor versions to major version, e.g. /3.1/DataObject.html to /3/DataObject.html
    RewriteCond %{REQUEST_URI} ^(.*)(\d)[.]\d/(.*)$ [NC]
    RewriteRule ^(\d)\.\d/(.*)$ %1%2/%3 [L,R=302]

    # Redirect language minor version to major version, e.g. /en/3.1/File.html to /3/File.html
    RewriteCond %{REQUEST_URI} ^(.*)en/([\d]+)[.][\w.]+/(.*)$ [NC]
    RewriteRule ^(.*)$ %1%2/%3 [L,R=302]

    # Class redirect. E.g.
    # /4/class-SilverStripe.AssetAdmin.Forms.FileSearchFormFactory.html
    # /4/SilverStripe/AssetAdmin/Forms/FileSearchFormFactory.html
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3.html [L,R=302]
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3/%4.html [L,R=302]
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.([\w]+)\.([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3/%4/%5.html [L,R=302]
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3/%4/%5/%6.html [L,R=302]
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3/%4/%5/%6/%7.html [L,R=302]
    RewriteCond %{REQUEST_URI} ^(.*)([\w.]+)/class-([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.([\w]+)\.html [NC]
    RewriteRule ^(.*)$ %1%2/%3/%4/%5/%6/%7/%8.html [L,R=302]

    ### ============= End Legacy redirects =============

    # Redirect base path to 6 index.html - default major version
    RewriteCond %{REQUEST_URI} ^(.*)$ [NC]
    RewriteRule ^/?$ /6/index.html [R=302,L]

    # Process through SilverStripe if no file with the requested name exists.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule .* index.php
</IfModule>
### SILVERSTRIPE END ###

